name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: "~> v2"
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Push Homebrew formula
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          TAG: ${{ github.ref_name }}
        run: |
          VERSION="${TAG#v}"

          # Download release archives to compute checksums
          BASE="https://github.com/BrunoPessoa22/fantokenintel-cli/releases/download/${TAG}"
          curl -sLO "${BASE}/fti_darwin_arm64.tar.gz"
          curl -sLO "${BASE}/fti_darwin_amd64.tar.gz"
          curl -sLO "${BASE}/fti_linux_arm64.tar.gz"
          curl -sLO "${BASE}/fti_linux_amd64.tar.gz"

          SHA_DARWIN_ARM64=$(sha256sum fti_darwin_arm64.tar.gz | awk '{print $1}')
          SHA_DARWIN_AMD64=$(sha256sum fti_darwin_amd64.tar.gz | awk '{print $1}')
          SHA_LINUX_ARM64=$(sha256sum fti_linux_arm64.tar.gz  | awk '{print $1}')
          SHA_LINUX_AMD64=$(sha256sum fti_linux_amd64.tar.gz  | awk '{print $1}')

          FORMULA=$(cat <<EOF
          class Fantokenintel < Formula
            desc "CLI for Fan Token Intel â€” market data, signals & whale tracking"
            homepage "https://fantokenintel.vercel.app"
            version "${VERSION}"
            license "MIT"

            on_macos do
              if Hardware::CPU.arm?
                url "${BASE}/fti_darwin_arm64.tar.gz"
                sha256 "${SHA_DARWIN_ARM64}"
              else
                url "${BASE}/fti_darwin_amd64.tar.gz"
                sha256 "${SHA_DARWIN_AMD64}"
              end
            end

            on_linux do
              if Hardware::CPU.arm?
                url "${BASE}/fti_linux_arm64.tar.gz"
                sha256 "${SHA_LINUX_ARM64}"
              else
                url "${BASE}/fti_linux_amd64.tar.gz"
                sha256 "${SHA_LINUX_AMD64}"
              end
            end

            def install
              bin.install "fti"
            end

            test do
              system "#{bin}/fti", "--version"
            end
          end
          EOF
          )

          # Get current SHA of formula file (needed for update; empty on first create)
          SHA=$(curl -s \
            -H "Authorization: Bearer ${HOMEBREW_TAP_TOKEN}" \
            "https://api.github.com/repos/BrunoPessoa22/homebrew-fantokenintel/contents/Formula/fantokenintel.rb" \
            | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('sha',''))" 2>/dev/null || echo "")

          CONTENT=$(echo "$FORMULA" | base64 -w 0)

          if [ -z "$SHA" ]; then
            BODY="{\"message\":\"formula: release ${VERSION}\",\"content\":\"${CONTENT}\"}"
          else
            BODY="{\"message\":\"formula: release ${VERSION}\",\"content\":\"${CONTENT}\",\"sha\":\"${SHA}\"}"
          fi

          # Ensure Formula/ directory exists by creating the file at that path
          HTTP=$(curl -s -o /tmp/tap_response.json -w "%{http_code}" \
            -X PUT \
            -H "Authorization: Bearer ${HOMEBREW_TAP_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "${BODY}" \
            "https://api.github.com/repos/BrunoPessoa22/homebrew-fantokenintel/contents/Formula/fantokenintel.rb")

          echo "GitHub API response: $HTTP"
          cat /tmp/tap_response.json | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('commit',{}).get('html_url', d.get('message','no message')))" 2>/dev/null || true

          if [ "$HTTP" != "200" ] && [ "$HTTP" != "201" ]; then
            echo "Failed to push formula (HTTP $HTTP)"
            exit 1
          fi

          echo "Homebrew formula pushed successfully."
